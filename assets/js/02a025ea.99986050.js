(self.webpackChunkdoc_ops=self.webpackChunkdoc_ops||[]).push([[8860],{9698:function(e,t,r){"use strict";r.r(t),r.d(t,{frontMatter:function(){return i},contentTitle:function(){return c},metadata:function(){return l},toc:function(){return u},default:function(){return m}});var n=r(2122),o=r(9756),a=(r(7294),r(3905)),s=["components"],i={},c="Return of tokens in case of failure",l={unversionedId:"tutorial/10",id:"tutorial/10",isDocsHomePage:!1,title:"Return of tokens in case of failure",description:"Natural question: what if I attach tokens to the request, send it to the smart",source:"@site/docs/tutorial/10.md",sourceDirName:"tutorial",slug:"/tutorial/10",permalink:"/docs/tutorial/10",editUrl:"https://github.com/iotaledger/chronicle.rs/tree/main/docs/docs/tutorial/10.md",version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Sending tokens to the smart contract",permalink:"/docs/tutorial/09"},next:{title:"Sending tokens from smart contract to address",permalink:"/docs/tutorial/11"}},u=[],p={toc:u};function m(e){var t=e.components,r=(0,o.Z)(e,s);return(0,a.kt)("wrapper",(0,n.Z)({},p,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"return-of-tokens-in-case-of-failure"},"Return of tokens in case of failure"),(0,a.kt)("p",null,"Natural question: what if I attach tokens to the request, send it to the smart\ncontract and the smart contract fails (panics)? The panics may occur for\nwhatever reason: it may be due to wrong parameters, or it may be a runtime\nerror, or a bug. What will happen with my tokens?"),(0,a.kt)("p",null,"The following test demonstrates the situation when the request results in a\npanic in the smart contract."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},'func TestTutorial7(t *testing.T) {\n    env := solo.New(t, false, false)\n    chain := env.NewChain(nil, "ex7")\n    \n    err := chain.DeployWasmContract(nil, "example1", "example_tutorial_bg.wasm")\n    require.NoError(t, err)\n    \n    contractAgentID := iscp.NewAgentID(chain.ChainID.AsAddress(), iscp.Hn("example1"))\n    \n    userWallet, userAddress := env.NewKeyPairWithFunds()\n    userAgentID := iscp.NewAgentID(userAddress, 0)\n    \n    env.AssertAddressBalance(userAddress, ledgerstate.ColorIOTA, solo.Saldo)\n    chain.AssertAccountBalance(contractAgentID, ledgerstate.ColorIOTA, 0) // empty on-chain\n    chain.AssertAccountBalance(userAgentID, ledgerstate.ColorIOTA, 0)     // empty on-chain\n    \n    // missing parameter, will panic\n    req := solo.NewCallParams("example1", "storeString")\n    req.WithIotas(42)\n    _, err = chain.PostRequestSync(req, userWallet)\n    require.Error(t, err)\n    \n    chain.AssertAccountBalance(contractAgentID, ledgerstate.ColorIOTA, 0)\n    chain.AssertAccountBalance(userAgentID, ledgerstate.ColorIOTA, 0)\n    env.AssertAddressBalance(userAddress, ledgerstate.ColorIOTA, solo.Saldo)\n}\n')),(0,a.kt)("p",null,"The programmer forgets the parameter ",(0,a.kt)("inlineCode",{parentName:"p"},"paramString")," and the program panics:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},"01:09.361   PANIC   TestTutorial7.ex7   vmcontext/log.go:12 string parameter not found\n01:09.363   INFO    TestTutorial7.ex7   vmcontext/runreq.go:311 eventlog -> '[req] [1]3F852PiSDkYXSjhDjLhqYK5bRVWtMkHA1fyicXEams3L: [1]3F852PiSDkYXSjhDjLhqYK5bRVWtMkHA1fyicXEams3L: recovered from panic in VM: string parameter not found'\n01:09.363   INFO    TestTutorial7.ex7.m mempool/mempool.go:119  OUT MEMPOOL [1]3F852PiSDkYXSjhDjLhqYK5bRVWtMkHA1fyicXEams3L\n01:09.363   INFO    TestTutorial7.ex7   solo/run.go:86  state transition #3 --\x3e #4. Requests in the block: 1. Outputs: 2\n")),(0,a.kt)("p",null,"We can see that all sent 42 tokens are returned to the sender's address."),(0,a.kt)("p",null,"In case of panic for whatever reason, the fallback logic of the VM context of\nISCP returns all tokens (minus fees) to the sender (to the sender's address the\nexample above)."))}m.isMDXComponent=!0},3905:function(e,t,r){"use strict";r.d(t,{Zo:function(){return u},kt:function(){return f}});var n=r(7294);function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function a(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function s(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?a(Object(r),!0).forEach((function(t){o(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):a(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t){if(null==e)return{};var r,n,o=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||(o[r]=e[r]);return o}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)r=a[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var c=n.createContext({}),l=function(e){var t=n.useContext(c),r=t;return e&&(r="function"==typeof e?e(t):s(s({},t),e)),r},u=function(e){var t=l(e.components);return n.createElement(c.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var r=e.components,o=e.mdxType,a=e.originalType,c=e.parentName,u=i(e,["components","mdxType","originalType","parentName"]),m=l(r),f=o,d=m["".concat(c,".").concat(f)]||m[f]||p[f]||a;return r?n.createElement(d,s(s({ref:t},u),{},{components:r})):n.createElement(d,s({ref:t},u))}));function f(e,t){var r=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var a=r.length,s=new Array(a);s[0]=m;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i.mdxType="string"==typeof e?e:o,s[1]=i;for(var l=2;l<a;l++)s[l]=r[l];return n.createElement.apply(null,s)}return n.createElement.apply(null,r)}m.displayName="MDXCreateElement"}}]);